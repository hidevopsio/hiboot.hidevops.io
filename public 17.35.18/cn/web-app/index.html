<!DOCTYPE html>
  
  
  
  
   
  <html class="no-js" lang="cn"> 
  

  <head lang="cn">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>网络应用 - Hiboot云原生应用框架</title>
    <meta name="generator" content="Hugo 0.59.1" />

    
    <meta name="description" content="Official site hidevops.io">
    
    <link rel="canonical" href="https://hiboot.hidevops.io/cn/web-app/">
    
    <meta name="author" content="John Deng">
    

    <meta property="og:url" content="https://hiboot.hidevops.io/cn/web-app/">
    <meta property="og:title" content="Hiboot云原生应用框架">
    <meta property="og:image" content="https://hiboot.hidevops.io/images/logo.png">
    <meta name="apple-mobile-web-app-title" content="Hiboot云原生应用框架">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://hiboot.hidevops.io/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://hiboot.hidevops.io/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://hiboot.hidevops.io/fonts/icon.eot');
        src: url('https://hiboot.hidevops.io/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://hiboot.hidevops.io/fonts/icon.woff')
               format('woff'),
             url('https://hiboot.hidevops.io/fonts/icon.ttf')
               format('truetype'),
             url('https://hiboot.hidevops.io/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://hiboot.hidevops.io/stylesheets/application.css">
    <link rel="stylesheet" href="https://hiboot.hidevops.io/stylesheets/_animation.css">
    <link rel="stylesheet" href="https://hiboot.hidevops.io/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://hiboot.hidevops.io/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://hiboot.hidevops.io/icons/style.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu&#43;Mono">
    <style>
      body, input {
        font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://hiboot.hidevops.io/javascripts/modernizr.js"></script>
    <script src="https://hiboot.hidevops.io/javascripts/growingio.js"></script>

    

  </head>
  <body class="palette-primary-cyan palette-accent-deep-purple">
    

<div class="backdrop">
    <div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
    <nav aria-label="Header">
    <div class="bar default zindex11">
        <div class="button button-menu" role="button" aria-label="Menu">
            <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
        </div>
        <div class="stretch">
            <div class="title">
                网络应用
            </div>
        </div>

        <div class="button button-home" role="button" aria-label="Home">
            <a href="https://hidevops.io" title="Home" target="_blank"  class="toggle-button icon icons-home"></a>
        </div>
        <div class="button button-twitter language_btn" role="button" aria-label="Twitter">
            <a href="javascript:;" title="Switch languages" class="toggle-button icons-globe"></a>
            <div class="layer_box">
                
                  
                
                  
                  <a href="https://hiboot.hidevops.io/en" lang="en">English</a>
                  
                
            </div>
        </div>
        
        <div class="button button-twitter" role="button" aria-label="Twitter">
            <a href="https://twitter.com/johndcn" title="@johndcn on Twitter" target="_blank" class="toggle-button icon icon-twitter"></a>
        </div>
         
        <div class="button button-github" role="button" aria-label="GitHub">
            <a href="https://github.com/hidevopsio" title="@hidevopsio on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
        </div>
        

        <div class="button button-search" role="button" aria-label="Search">
            <label class="toggle-button icon icon-search" title="Search" for="toggle-search"></label>
        </div>
    </div>
    <div class="bar search">
        <div class="button button-close" role="button" aria-label="Close">
            <label class="toggle-button icon icon-back" for="toggle-search"></label>
        </div>
        <div class="stretch">
            <div class="field">
                <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
            </div>
        </div>
        <div class="button button-reset" role="button" aria-label="Search">
            <button class="toggle-button icon icon-close" id="reset-search"></button>
        </div>
    </div>
</nav>
</header>

<main class="main">
    <div class="drawer">
        <nav aria-label="Navigation">
    <a href="https://hiboot.hidevops.io/cn" class="project">
        <div class="banner">
            
            <div class="logo">
                <img src="https://hiboot.hidevops.io/images/logo.png">
            </div>
            
            <div class="name">
                <strong>Hiboot云原生应用框架 <span class="version">v1.2.1</span></strong> 
                <br> 
            </div>
        </div>
    </a>

    <div class="scrollable">
        <div class="wrapper">
            
            <ul class="repo">
                <li class="repo-download">
                    <a href="//archive/master.zip" target="_blank" title="Download" data-action="download">
                        <i class="icon icon-download"></i> Download
                    </a>
                </li>
                <li class="repo-stars">
                    <a href="//stargazers" target="_blank" title="Stargazers" data-action="star">
                        <i class="icon icon-star"></i> Stars
                        <span class="count">&ndash;</span>
                    </a>
                </li>
            </ul>
            <hr> 

            <div class="toc">
                
                <ul>
                    
<nav role="navigation">
  <ul class="list pa0 nl2">
    
      
      <li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8">
        <a href="javascript:void(0)" class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2  primary-parent-color" data-target=".Hiboot云原生应用框架">Hiboot云原生应用框架</a>
        <ul class="Hiboot云原生应用框架 desktopmenu animated fadeIn list pl0 bg-light-gray db">
          <li class="f6 fw4">
            <a href="https://hiboot.hidevops.io/cn/getting-started/" class="db link hover-bg-gray hover-white pl3 pr2 pv2 black ">
              入门
            </a>
          </li>
          <li class="f6 fw4">
            <a href="https://hiboot.hidevops.io/cn/cli-app/" class="db link hover-bg-gray hover-white pl3 pr2 pv2 black ">
              命令行应用
            </a>
          </li>
          <li class="f6 fw4">
            <a href="https://hiboot.hidevops.io/cn/web-app/" class="db link hover-bg-gray hover-white pl3 pr2 pv2 primary-color ">
              网络应用
            </a>
          </li>
          <li class="f6 fw4">
            <a href="https://hiboot.hidevops.io/cn/auto-configure/" class="db link hover-bg-gray hover-white pl3 pr2 pv2 black ">
              自动配置
            </a>
          </li>
        </ul>
      </li>
  </ul>
</nav>

                </ul>
                 
                <hr>
                <span class="section">The author</span>

                <ul>
                    
                    <li>
                        <a href="https://twitter.com/johndcn" target="_blank" title="@johndcn on Twitter">
              @johndcn on Twitter
            </a>
                    </li>
                     
                    <li>
                        <a href="https://github.com/hidevopsio" target="_blank" title="@hidevopsio on GitHub">
              @hidevopsio on GitHub
            </a>
                    </li>
                     
                    <li>
                        <a href="mailto:hi.devops.io@gmail.com" title="Email of hi.devops.io@gmail.com">
              Contact via email
            </a>
                    </li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</nav>
    </div>
    <article class="article">
        <div class="wrapper">
            <div class="contentWrapper">
                <h1>网络应用 </h1>
                

<h2 id="主要功能">主要功能</h2>

<ul>
<li>MVC架构 (Model-View-Controller).</li>
<li>自动配置, 事先配置好的依赖包可以被注入到任何你指定的构造函数参数中或者结构体变量</li>
<li>依赖注入， 使用标签 `inject:&ldquo;&rdquo;` 或者构造函数来实现.</li>
</ul>

<h2 id="mvc架构介绍">MVC架构介绍</h2>

<p>Hiboot点MVC架构采用约定俗成的原则，尽量隐藏和业务无关的代码，开发者只需遵循少数几个简单的规则即可。</p>

<ul>
<li>运行时动态配置及配置值注入</li>
<li>注册机制</li>
<li>依赖注入</li>
</ul>

<p>在<a href="https://hiboot.hidevops.io/cn/getting-started/">入门</a>这个章节我们了解到了简单Hiboot网络应用，现在我们以<a href="https://hidevops.io/hiboot-data//examples/gorm">hiboot-data gorm 示例代码</a>为例，来详细讲解任何有效的基于Hiboot来编程。</p>

<h2 id="mvc项目结构详解">MVC项目结构详解</h2>

<p>下面是典型的hiboot MVC项目结构，接下来我们来对每个文件一一做详细说明。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">.
├── config
│   ├── application-gorm.yml
│   ├── application-local.yml
│   ├── application.yml
│   ├── i18n
│   │   ├── en-US.ini
│   │   └── zh-CN.ini
│   ├── keygen.sh
│   └── ssl
│       ├── app.rsa
│       └── app.rsa.pub
├── main.go
├── main_test.go
├── controller
│   ├── user.go
│   └── user_test.go
├── entity
│   ├── user.go
│   └── user_test.go
└── service
    ├── user.go
    └── user_test.go</code></pre></div>
<p>Hiboot应用分两部分，外部配置及源代码。</p>

<h2 id="外部配置">外部配置</h2>

<p>Hiboot要做可用于生产的应用框架，在设计之初就考虑到了需要适应不同的环境。在工作目录下的config文件夹包含了不同环境下的配置文件.</p>

<p>Hiboot允许将配置外部化，这样你就能够在不同的环境下使用相同的代码。</p>

<p>属性值可以通过`value:&ldquo;&rdquo;`标签直接注入到结构体中，</p>

<p>下面是具体的示例，假设你开发一个使用app.name属性的struct, 如下面例子：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">MyService</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">AppName</span> <span class="kt">string</span> <span class="s">`value:&#34;${app.name}&#34;`</span>
<span class="p">}</span></code></pre></div>
<h2 id="通用application属性文件">通用Application属性文件</h2>

<p>Hiboot将从工作路径下的config文件夹中加载application.yml文件.</p>

<h3 id="config-application-yml">config/application.yml</h3>

<p><code>application.yml</code>定义应用项目、名称等基本信息</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">app<span class="p">:</span><span class="w">
</span><span class="w">  </span>project<span class="p">:</span><span class="w"> </span>examples<span class="w">  
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>gorm-demo<span class="w">
</span><span class="w">  </span>profiles<span class="p">:</span><span class="w">
</span><span class="w">    </span>include<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>actuator<span class="w">
</span><span class="w">    </span>-<span class="w"> </span>locale<span class="w">
</span><span class="w">    </span>-<span class="w"> </span>logging<span class="w">
</span><span class="w">    </span>-<span class="w"> </span>gorm<span class="w">
</span><span class="w">
</span><span class="w"></span>logging<span class="p">:</span><span class="w">
</span><span class="w">  </span>level<span class="p">:</span><span class="w"> </span>info</code></pre></div>
<h3 id="application-yml字段说明">application.yml字段说明</h3>

<table>
<thead>
<tr>
<th>字段</th>
<th>描述</th>
<th>合法值</th>
<th>示例</th>
</tr>
</thead>

<tbody>
<tr>
<td>app.project</td>
<td>项目名称</td>
<td>任意字符串</td>
<td>examples</td>
</tr>

<tr>
<td>app.name</td>
<td>应用名称</td>
<td>任意字符串</td>
<td>gorm-demo</td>
</tr>

<tr>
<td>app.profiles.active</td>
<td>当前环境配置</td>
<td>local,dev,test,staging,prod</td>
<td>dev</td>
</tr>

<tr>
<td>profiles.include</td>
<td>starter的开关功能，⚠️ 如果没有包含进来，则该starter不会被初始化，相关依赖不能被注入</td>
<td>starter包名</td>
<td>actuator, locale, logging, gorm</td>
</tr>

<tr>
<td>logging.level</td>
<td>定义日志级别</td>
<td>debug,info,warn,error,fatal</td>
<td>info</td>
</tr>
</tbody>
</table>

<p><strong>任何以某个字符名称为后缀的配置文件，有两种情况:</strong></p>

<ol>
<li>事先定义了相关环境变量，Hiboot会认为当前应用运行在不同的环境下，如<code>config/application-local.yml</code>为本地开发环境，在本地电脑需要设置环境变量<code>APP_PROFILES_ACTIVE</code> 为 <code>local</code></li>
<li>引用了starter，可以将starter的属性值配置到<code>application.yml</code>, 也可以将其配置到以starter包名为后缀的配置文件中，如本例的<code>application-gorm.yml</code></li>
</ol>

<h3 id="config-application-local-yml">config/application-local.yml</h3>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">server<span class="p">:</span><span class="w">
</span><span class="w">  </span>port<span class="p">:</span><span class="w"> </span><span class="m">8081</span><span class="w">
</span><span class="w">
</span><span class="w"></span>logging<span class="p">:</span><span class="w">
</span><span class="w">  </span>level<span class="p">:</span><span class="w"> </span>debug</code></pre></div>
<h3 id="application-local-yml-字段说明">application-local.yml 字段说明</h3>

<table>
<thead>
<tr>
<th>字段</th>
<th>描述</th>
<th>合法值</th>
<th>示例</th>
</tr>
</thead>

<tbody>
<tr>
<td>server.port</td>
<td>监听端口, 通常在本地开发应用时可能有多个应用同时运行，为例防止端口冲突，可以定义不同的端口</td>
<td>任意数字</td>
<td>8081</td>
</tr>

<tr>
<td>logging.level</td>
<td>定义日志级别</td>
<td>debug,info,warn,error,fatal</td>
<td>info</td>
</tr>
</tbody>
</table>

<h3 id="config-application-gorm-yml">config/application-gorm.yml</h3>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">gorm<span class="p">:</span><span class="w">
</span><span class="w">  </span>type<span class="p">:</span><span class="w"> </span>mysql<span class="w">
</span><span class="w">  </span>host<span class="p">:</span><span class="w"> </span>mysql-${app.profiles.active<span class="p">:</span>dev}<span class="w">
</span><span class="w">  </span>port<span class="p">:</span><span class="w"> </span><span class="m">3306</span><span class="w">
</span><span class="w">  </span>database<span class="p">:</span><span class="w"> </span>${app.name<span class="p">:</span>test}<span class="w">
</span><span class="w">  </span>username<span class="p">:</span><span class="w"> </span>demo<span class="w">
</span><span class="w">  </span>password<span class="p">:</span><span class="w"> </span>fafUJCsVXf2Thj0d4n6UqNdX2PfI08fMyaNlrZhbJVVkghnZ+Zc/WCdITXflJpHZjYH5+LbLviy/6j9etPNwtdyAOXiqKI62itC6nDgp0Xlzu0qX8MwMIIAosUwaYpnflg23hRZnueKrq6SrEpkx4X+LWluDgHb2O5VfGGvHliE=<span class="w">
</span><span class="w">  </span>charset<span class="p">:</span><span class="w"> </span>utf8<span class="w">
</span><span class="w">  </span>parseTime<span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span>loc<span class="p">:</span><span class="w"> </span>Asia/Shanghai<span class="w">
</span><span class="w">  </span>config<span class="p">:</span><span class="w">
</span><span class="w">    </span>decrypt<span class="p">:</span><span class="w"> </span><span class="kc">true</span></code></pre></div>
<h4 id="application-gorm-yml字段说明">application-gorm.yml字段说明</h4>

<table>
<thead>
<tr>
<th>字段</th>
<th>描述</th>
<th>合法值</th>
<th>示例</th>
</tr>
</thead>

<tbody>
<tr>
<td>gorm.type</td>
<td>数据库类型, 支持的有多种数据库</td>
<td>mysql,postgres,sqlite3,mssql</td>
<td>mysql</td>
</tr>

<tr>
<td>gorm.host</td>
<td>数据库地址，允许使用变量 <code>mysql-${app.profiles.active}</code> 如在本地开发环境，设置环境变量<code>APP_PROFILES_ACTIVE</code> 为 <code>local</code>，则实际值为<code>mysql-local</code>，添加一条DNS的A记录即可</td>
<td>任何合法DNS域名或IP地址（字符串类型）</td>
<td><code>mysql-${app.profiles.active}</code></td>
</tr>

<tr>
<td>gorm.port</td>
<td>数据库端口</td>
<td>任何有效端口</td>
<td>3306</td>
</tr>

<tr>
<td>gorm.database</td>
<td>数据库名称</td>
<td>字符或变量</td>
<td><code>${app.name:test}</code></td>
</tr>

<tr>
<td>gorm.username</td>
<td>数据库用户名</td>
<td>合法的数据库用户名</td>
<td>dbuser</td>
</tr>

<tr>
<td>gorm.password</td>
<td>数据库密码，如果gorm.config.decrypt为true，则为<a href="https://github.com/hidevopsio/crypto">crypto</a>加密过的数据库密码</td>
<td>字符串</td>
<td>fafUJ &hellip; O5VfGGvHliE=</td>
</tr>

<tr>
<td>gorm.charset</td>
<td>数据库字符集</td>
<td>utf8,ascii</td>
<td>utf8</td>
</tr>

<tr>
<td>gorm.parseTime</td>
<td>是否解析时间</td>
<td>true,false</td>
<td>true</td>
</tr>

<tr>
<td>gorm.loc</td>
<td>本地时区</td>
<td>参考<a href="https://www.worldtimezone.com/index_cn.php">标准时区</a></td>
<td>Asia/Shanghai</td>
</tr>

<tr>
<td>gorm.config.decrypt</td>
<td>是否加密密码</td>
<td>true,false</td>
<td>true</td>
</tr>
</tbody>
</table>

<h3 id="main-go">main.go</h3>

<p>和任何Go语言应用一样，Hiboot的程序入口为main包，包含两部分：引入用到的依赖包以及一个main函数。</p>

<ol>
<li><p>为了解耦包与包之间的依赖关系，hiboot规定，依赖项采用注册，依赖注入的方式来解耦，故在main包里想要匿名引入MVC控制器<code>hidevops.io/hiboot-data/examples/gorm/controller</code>, 如果使用到了其它第三方自动配置包（这里一般是指starter），而代码没有显式使用的，也要匿名引人，如：<code>hidevops.io/hiboot/pkg/starter/actuator</code>, <code>hidevops.io/hiboot/pkg/starter/locale</code>, <code>hidevops.io/hiboot/pkg/starter/logging</code></p></li>

<li><p>main函数非常简单，只有一行代码 <code>web.NewApplication().Run()</code>, <code>web</code>包引自<code>hidevops.io/hiboot/pkg/app/web</code></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="nx">_</span> <span class="s">&#34;hidevops.io/hiboot-data/examples/gorm/controller&#34;</span>
	<span class="s">&#34;hidevops.io/hiboot/pkg/app/web&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;hidevops.io/hiboot/pkg/starter/actuator&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;hidevops.io/hiboot/pkg/starter/locale&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;hidevops.io/hiboot/pkg/starter/logging&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">web</span><span class="p">.</span><span class="nf">NewApplication</span><span class="p">().</span><span class="nf">Run</span><span class="p">()</span>
<span class="p">}</span></code></pre></div></li>
</ol>

<h3 id="mian-test-go">mian_test.go</h3>

<p>main函数单元测试，<code>TestRunMain</code>第一行代码是 <code>go main()</code>, 我们起一个go routine来无阻塞的测试main函数，后面代码<code>time.Sleep(200 * time.Millisecond)</code>做个简单延时，可以用于main函数代码覆盖测试。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;testing&#34;</span>
	<span class="s">&#34;time&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">TestRunMain</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">go</span> <span class="nf">main</span><span class="p">()</span>
	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">200</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>
<h3 id="控制器-controller-user-go">控制器 - controller/user.go</h3>

<p>接下来我们来看看如何正确编写Hiboot的控制器，</p>

<p>控制器 <code>userController</code> 内嵌 <code>at.RestController</code>, 指明这是个RESTful控制器。</p>

<p><code>newUserController</code>为<code>userController</code>的构造函数，实现依赖注入，在应用启动过程中， <code>userService service.UserService</code> 将被自动注入到 <code>newUserController</code>。</p>

<p>控制器是RESTful接口的入口，不同于其它Go语言网络应用框架，Hiboot控制器设计思路是尽可能的简单易用，省去路由配置代码，约定方法名即路由配置。如下userController的Post方法。</p>

<p>现针对各个方法作详细说明</p>

<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
<th>合法值</th>
<th>示例</th>
</tr>
</thead>

<tbody>
<tr>
<td>Get</td>
<td>GET请求</td>
<td>Get或以大写开头的驼峰命名法则GetById</td>
<td><code>func (c *userController) GetById(id unit64)</code></td>
</tr>

<tr>
<td>Post</td>
<td>POST请求</td>
<td>Post或以大写开头的驼峰命名法则PostUser</td>
<td><code>func (c *userController) Post(request *userRequest)</code></td>
</tr>

<tr>
<td>Put</td>
<td>PUT请求</td>
<td>Put或以大写开头的驼峰命名法则PutUser</td>
<td><code>func (c *userController) Post(request *userRequest)</code></td>
</tr>

<tr>
<td>Delete</td>
<td>DELETE请求</td>
<td>Delete或以大写开头的驼峰命名法则DeleteById</td>
<td><code>func (c *userController) DeleteById(id unit64)</code></td>
</tr>
</tbody>
</table>

<p>⚠️ 在函数 <code>init()</code> 必须注册 newUserController.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">controller</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;hidevops.io/hiboot-data/examples/gorm/entity&#34;</span>
	<span class="s">&#34;hidevops.io/hiboot-data/examples/gorm/service&#34;</span>
	<span class="s">&#34;hidevops.io/hiboot/pkg/app&#34;</span>
	<span class="s">&#34;hidevops.io/hiboot/pkg/app/web&#34;</span>
	<span class="s">&#34;hidevops.io/hiboot/pkg/model&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
<span class="p">)</span>

<span class="c1">// RestController
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">userController</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">at</span><span class="p">.</span><span class="nx">RestController</span>
	<span class="nx">userService</span> <span class="nx">service</span><span class="p">.</span><span class="nx">UserService</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">app</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">newUserController</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// newUserController inject userService automatically
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">newUserController</span><span class="p">(</span><span class="nx">userService</span> <span class="nx">service</span><span class="p">.</span><span class="nx">UserService</span><span class="p">)</span> <span class="o">*</span><span class="nx">userController</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">userController</span><span class="p">{</span>
		<span class="nx">userService</span><span class="p">:</span> <span class="nx">userService</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Post POST /user
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">userController</span><span class="p">)</span> <span class="nf">Post</span><span class="p">(</span><span class="nx">request</span> <span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span> <span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">userService</span><span class="p">.</span><span class="nf">AddUser</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span>
	<span class="nx">response</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">BaseResponse</span><span class="p">)</span>
	<span class="nx">response</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// GetById GET /id/{id}
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">userController</span><span class="p">)</span> <span class="nf">GetById</span><span class="p">(</span><span class="nx">id</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="nx">response</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">user</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">userService</span><span class="p">.</span><span class="nf">GetUser</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
	<span class="nx">response</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">BaseResponse</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">response</span><span class="p">.</span><span class="nf">SetCode</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusNotFound</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">response</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span>
<span class="p">}</span>

<span class="c1">// GetById GET /id/{id}
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">userController</span><span class="p">)</span> <span class="nf">GetAll</span><span class="p">()</span> <span class="p">(</span><span class="nx">response</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">users</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">userService</span><span class="p">.</span><span class="nf">GetAll</span><span class="p">()</span>
	<span class="nx">response</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">BaseResponse</span><span class="p">)</span>
	<span class="nx">response</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="nx">users</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span>

<span class="c1">// DeleteById DELETE /id/{id}
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">userController</span><span class="p">)</span> <span class="nf">DeleteById</span><span class="p">(</span><span class="nx">id</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="nx">response</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">err</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">userService</span><span class="p">.</span><span class="nf">DeleteUser</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
	<span class="nx">response</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">BaseResponse</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span></code></pre></div>
<h3 id="entity-user-go">entity/user.go</h3>

<p>这是业务逻辑模型。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">entity</span>

<span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Id</span>       <span class="kt">uint64</span> <span class="s">`json:&#34;id&#34;`</span>
	<span class="nx">Name</span>     <span class="kt">string</span> <span class="s">`json:&#34;name&#34;`</span>
	<span class="nx">Username</span> <span class="kt">string</span> <span class="s">`json:&#34;username&#34;`</span>
	<span class="nx">Password</span> <span class="kt">string</span> <span class="s">`json:&#34;password&#34;`</span>
	<span class="nx">Email</span>    <span class="kt">string</span> <span class="s">`json:&#34;email&#34;`</span>
	<span class="nx">Age</span>      <span class="kt">uint</span>   <span class="s">`json:&#34;age&#34;`</span>
	<span class="nx">Gender</span>   <span class="kt">uint</span>   <span class="s">`json:&#34;gender&#34;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">User</span><span class="p">)</span> <span class="nf">TableName</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="k">return</span> <span class="s">&#34;user&#34;</span>
<span class="p">}</span></code></pre></div>
<h3 id="model-service-user-go">Model -  service/user.go</h3>

<p>service包实现业务逻辑。</p>

<p>我们定义了一个接口<code>UserService</code>，包含<code>AddUser</code>, <code>GetUser</code>, <code>GetAll</code> 和 <code>DeleteUser</code>方法。</p>

<p>userServiceImpl为接口UserService的具体实现。</p>

<p>通过引人<code>hiboot-data/starter/gorm</code>，即可自动注入 <code>repository gorm.Repository</code>到<code>userServiceImpl</code></p>

<p>⚠️ 在函数 <code>init()</code> 必须注册 newUserService.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">service</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;errors&#34;</span>
	<span class="s">&#34;hidevops.io/hiboot-data/examples/gorm/entity&#34;</span>
	<span class="s">&#34;hidevops.io/hiboot-data/starter/gorm&#34;</span>
	<span class="s">&#34;hidevops.io/hiboot/pkg/app&#34;</span>
	<span class="s">&#34;hidevops.io/hiboot/pkg/utils/idgen&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">UserService</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">AddUser</span><span class="p">(</span><span class="nx">user</span> <span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
	<span class="nf">GetUser</span><span class="p">(</span><span class="nx">id</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="nx">user</span> <span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
	<span class="nf">GetAll</span><span class="p">()</span> <span class="p">(</span><span class="nx">user</span> <span class="o">*</span><span class="p">[]</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
	<span class="nf">DeleteUser</span><span class="p">(</span><span class="nx">id</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">userServiceImpl</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// add UserService, it means that the instance of UserServiceImpl can be found by UserService
</span><span class="c1"></span>	<span class="nx">UserService</span>
	<span class="nx">repository</span> <span class="nx">gorm</span><span class="p">.</span><span class="nx">Repository</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// register UserServiceImpl
</span><span class="c1"></span>	<span class="nx">app</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">newUserService</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// will inject BoltRepository that configured in hidevops.io/hiboot/pkg/starter/data/bolt
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">newUserService</span><span class="p">(</span><span class="nx">repository</span> <span class="nx">gorm</span><span class="p">.</span><span class="nx">Repository</span><span class="p">)</span> <span class="nx">UserService</span> <span class="p">{</span>
	<span class="nx">repository</span><span class="p">.</span><span class="nf">AutoMigrate</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">{})</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">userServiceImpl</span><span class="p">{</span>
		<span class="nx">repository</span><span class="p">:</span> <span class="nx">repository</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">userServiceImpl</span><span class="p">)</span> <span class="nf">AddUser</span><span class="p">(</span><span class="nx">user</span> <span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">user</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;user is not allowed nil&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Id</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">user</span><span class="p">.</span><span class="nx">Id</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">idgen</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">repository</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nf">Error</span><span class="p">()</span>
	<span class="k">return</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">userServiceImpl</span><span class="p">)</span> <span class="nf">GetUser</span><span class="p">(</span><span class="nx">id</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="nx">user</span> <span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">user</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">{}</span>
	<span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">repository</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;id = ?&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">).</span><span class="nf">First</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nf">Error</span><span class="p">()</span>
	<span class="k">return</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">userServiceImpl</span><span class="p">)</span> <span class="nf">GetAll</span><span class="p">()</span> <span class="p">(</span><span class="nx">users</span> <span class="o">*</span><span class="p">[]</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">users</span> <span class="p">=</span> <span class="o">&amp;</span><span class="p">[]</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">{}</span>
	<span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">repository</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="nx">users</span><span class="p">).</span><span class="nf">Error</span><span class="p">()</span>
	<span class="k">return</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">userServiceImpl</span><span class="p">)</span> <span class="nf">DeleteUser</span><span class="p">(</span><span class="nx">id</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">repository</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;id = ?&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">).</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">{}).</span><span class="nf">Error</span><span class="p">()</span>
	<span class="k">return</span>
<span class="p">}</span></code></pre></div>
<h2 id="运行网络应用程序">运行网络应用程序</h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">go run main.go</code></pre></div>
<p>输出结果如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">______  ____________             _____
___  / / /__<span class="o">(</span>_<span class="o">)</span>__  /_______________  /_
__  /_/ /__  /__  __ <span class="se">\ </span> __ <span class="se">\ </span> __ <span class="se">\ </span> __/
_  __  / _  / _  /_/ / /_/ / /_/ / /_     Hiboot Application Framework
/_/ /_/  /_/  /_.___/<span class="se">\_</span>___/<span class="se">\_</span>___/<span class="se">\_</span>_/     https://hidevops.io/hiboot

<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2018</span>/10/23 <span class="m">23</span>:37 Starting Hiboot web application gorm-demo on localhost with PID <span class="m">28423</span>
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2018</span>/10/23 <span class="m">23</span>:37 Working directory: /Users/johnd/.gvm/pkgsets/go1.10/hidevops/src/hidevops.io/hiboot-data/examples/gorm
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2018</span>/10/23 <span class="m">23</span>:37 The following profiles are active: local, <span class="o">[</span>actuator locale logging gorm<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2018</span>/10/23 <span class="m">23</span>:37 Auto configure gorm starter
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2018</span>/10/23 <span class="m">23</span>:37 Auto configure locale starter
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2018</span>/10/23 <span class="m">23</span>:37 Auto configure logging starter
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2018</span>/10/23 <span class="m">23</span>:37 The dependency graph resolved successfully
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2018</span>/10/23 <span class="m">23</span>:37 connected to dataSource demo@mysql-local:3306/gorm_demo
<span class="o">[</span>DBUG<span class="o">]</span> <span class="m">2018</span>/10/23 <span class="m">23</span>:36 GET: /health -&gt; github.com/hidevops	io/hiboot-data/vendor/hidevops.io/hiboot/pkg/starter/actuator/controller/healthController.Get<span class="o">()</span> and <span class="m">2</span> more
<span class="o">[</span>DBUG<span class="o">]</span> <span class="m">2018</span>/10/23 <span class="m">23</span>:36 DELETE: /user/id/<span class="o">{</span>id<span class="o">}</span> -&gt; hidevops.io/hiboot-data/examples/gorm/controller/userController.DeleteById<span class="o">()</span> and <span class="m">2</span> more
<span class="o">[</span>DBUG<span class="o">]</span> <span class="m">2018</span>/10/23 <span class="m">23</span>:36 GET: /user/id/<span class="o">{</span>id<span class="o">}</span> -&gt; hidevops.io/hiboot-data/examples/gorm/controller/userController.GetById<span class="o">()</span> and <span class="m">2</span> more
<span class="o">[</span>DBUG<span class="o">]</span> <span class="m">2018</span>/10/23 <span class="m">23</span>:36 GET: /user/all -&gt; hidevops.io/hiboot-data/examples/gorm/controller/userController.GetAll<span class="o">()</span> and <span class="m">2</span> more
<span class="o">[</span>DBUG<span class="o">]</span> <span class="m">2018</span>/10/23 <span class="m">23</span>:36 POST: /user -&gt; hidevops.io/hiboot-data/examples/gorm/controller/userController.Post<span class="o">()</span> and <span class="m">2</span> more

Now listening on: http://localhost:8080
Application started. Press CMD+C to shut down.</code></pre></div>
<h2 id="请求接口">请求接口</h2>

<p>让我们用<a href="https://httpie.org/">httpie</a>来请求接口</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">http GET localhost:8080/user/all?lang<span class="o">=</span>zh-CN</code></pre></div>
<p>输出结果如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">HTTP/1.1 <span class="m">200</span> OK
Content-Length: <span class="m">307</span>
Content-Type: application/json<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
Date: Tue, <span class="m">23</span> Oct <span class="m">2018</span> <span class="m">15</span>:38:41 GMT
Set-Cookie: app.language<span class="o">=</span>zh-CN<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/<span class="p">;</span> <span class="nv">Expires</span><span class="o">=</span>Tue, <span class="m">23</span> Oct <span class="m">2018</span> <span class="m">17</span>:38:41 GMT<span class="p">;</span> Max-Age<span class="o">=</span><span class="m">7200</span><span class="p">;</span> HttpOnly

<span class="o">{</span>
    <span class="s2">&#34;code&#34;</span>: <span class="m">200</span>,
    <span class="s2">&#34;data&#34;</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">&#34;age&#34;</span>: <span class="m">18</span>,
            <span class="s2">&#34;email&#34;</span>: <span class="s2">&#34;john.doe@gmail.com&#34;</span>,
            <span class="s2">&#34;gender&#34;</span>: <span class="m">0</span>,
            <span class="s2">&#34;id&#34;</span>: <span class="m">209536579658580081</span>,
            <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;John Doe&#34;</span>,
            <span class="s2">&#34;password&#34;</span>: <span class="s2">&#34;poi321&#34;</span>,
            <span class="s2">&#34;username&#34;</span>: <span class="s2">&#34;johnd&#34;</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">&#34;age&#34;</span>: <span class="m">25</span>,
            <span class="s2">&#34;email&#34;</span>: <span class="s2">&#34;mike.phil@gmail.com&#34;</span>,
            <span class="s2">&#34;gender&#34;</span>: <span class="m">0</span>,
            <span class="s2">&#34;id&#34;</span>: <span class="m">209536656246571121</span>,
            <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;Mike Phil&#34;</span>,
            <span class="s2">&#34;password&#34;</span>: <span class="s2">&#34;iutg039&#34;</span>,
            <span class="s2">&#34;username&#34;</span>: <span class="s2">&#34;mikep&#34;</span>
        <span class="o">}</span>
    <span class="o">]</span>,
    <span class="s2">&#34;message&#34;</span>: <span class="s2">&#34;成功&#34;</span>
<span class="o">}</span></code></pre></div>
<h2 id="单元测试">单元测试</h2>

<p>我说过，Hiboot从一开始就考虑到必须能用于生产环境，我们非常在意代码质量。你可以看我们集成了CI流程，代码必须通过严格的测试之后才会合并到主分支。这是Hiboot实时的代码测试覆盖率 <a href="https://codecov.io/gh/hidevopsio/hiboot"><img src="https://codecov.io/gh/hidevopsio/hiboot/branch/master/graph/badge.svg" alt="codecov" /></a>.  那么，我们是怎样来做单元测试的呢?</p>

<p>首先，让我们来看main.go下面最简单的单元测试，</p>

<h3 id="mian-test-go-1">mian_test.go</h3>

<p>为了简单起见, 我们用一个go routine 来跑main函数的测试 <code>go main()</code> 在这个单元测试用例 <code>TestRunMain</code>。当然这不是真正意义上的测试， 因为里面并没有assert语句，我们并不知道测试结果。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;testing&#34;</span>
	<span class="s">&#34;time&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">TestRunMain</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">go</span> <span class="nf">main</span><span class="p">()</span>
	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">200</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>
<h3 id="模拟测试-controller-user-test-go">模拟测试 - controller/user_test.go</h3>

<p>我们想测试 <code>userController</code>, 但是<code>userController</code> 依赖了 <code>userSerivce</code>，而<code>userSerivce</code> 又会连接真正的数据库，可是我们要做自动化测试，我们要做持续集成怎么办？当然我们可以使用模拟测试法。</p>

<p>我们使用模拟测试代码生成工具<a href="https://github.com/vektra/mockery">Mockery</a> 来生成部分测试代码，以减轻我们写代码的负担。</p>

<p>首先，我们来安装<a href="https://github.com/vektra/mockery">Mockery</a></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">go get github.com/vektra/mockery/.../</code></pre></div>
<p>然后，为接口UserService生成模拟测试代码，当然你得到相应的文件夹下面去生成代码，你也可以指定文件夹，具体方法可以看Mockery的帮助文档（运行 mockery -h 查看）</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># go to the directory where the UserService is.</span>
<span class="nb">cd</span> <span class="nv">$GOPATH</span>/src/hidevops.io/hiboot-data/examples/gorm/service

<span class="c1"># generate mocks for the interface UserService</span>
mockery -name UserService</code></pre></div>
<p>接下来，你将会在项目下面<code>（$GOPATH/src/hidevops.io/hiboot-data/examples/gorm/service.)</code>看到生成好的模拟测试代码。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Code generated by mockery v1.0.0. DO NOT EDIT.
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">mocks</span>

<span class="kn">import</span> <span class="nx">entity</span> <span class="s">&#34;hidevops.io/hiboot-data/examples/gorm/entity&#34;</span>
<span class="kn">import</span> <span class="nx">mock</span> <span class="s">&#34;github.com/stretchr/testify/mock&#34;</span>

<span class="c1">// UserService is an autogenerated mock type for the UserService type
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">UserService</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">mock</span><span class="p">.</span><span class="nx">Mock</span>
<span class="p">}</span>

<span class="c1">// AddUser provides a mock function with given fields: user
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">_m</span> <span class="o">*</span><span class="nx">UserService</span><span class="p">)</span> <span class="nf">AddUser</span><span class="p">(</span><span class="nx">user</span> <span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">ret</span> <span class="o">:=</span> <span class="nx">_m</span><span class="p">.</span><span class="nf">Called</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span>

	<span class="kd">var</span> <span class="nx">r0</span> <span class="kt">error</span>
	<span class="k">if</span> <span class="nx">rf</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ret</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="mi">0</span><span class="p">).(</span><span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span> <span class="kt">error</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">r0</span> <span class="p">=</span> <span class="nf">rf</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">r0</span> <span class="p">=</span> <span class="nx">ret</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">r0</span>
<span class="p">}</span>

<span class="c1">// DeleteUser provides a mock function with given fields: id
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">_m</span> <span class="o">*</span><span class="nx">UserService</span><span class="p">)</span> <span class="nf">DeleteUser</span><span class="p">(</span><span class="nx">id</span> <span class="kt">uint64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">ret</span> <span class="o">:=</span> <span class="nx">_m</span><span class="p">.</span><span class="nf">Called</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>

	<span class="kd">var</span> <span class="nx">r0</span> <span class="kt">error</span>
	<span class="k">if</span> <span class="nx">rf</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ret</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="mi">0</span><span class="p">).(</span><span class="kd">func</span><span class="p">(</span><span class="kt">uint64</span><span class="p">)</span> <span class="kt">error</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">r0</span> <span class="p">=</span> <span class="nf">rf</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">r0</span> <span class="p">=</span> <span class="nx">ret</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">r0</span>
<span class="p">}</span>

<span class="c1">// GetAll provides a mock function with given fields:
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">_m</span> <span class="o">*</span><span class="nx">UserService</span><span class="p">)</span> <span class="nf">GetAll</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="p">[]</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">ret</span> <span class="o">:=</span> <span class="nx">_m</span><span class="p">.</span><span class="nf">Called</span><span class="p">()</span>

	<span class="kd">var</span> <span class="nx">r0</span> <span class="o">*</span><span class="p">[]</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span>
	<span class="k">if</span> <span class="nx">rf</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ret</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="mi">0</span><span class="p">).(</span><span class="kd">func</span><span class="p">()</span> <span class="o">*</span><span class="p">[]</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">r0</span> <span class="p">=</span> <span class="nf">rf</span><span class="p">()</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">ret</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">r0</span> <span class="p">=</span> <span class="nx">ret</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="mi">0</span><span class="p">).(</span><span class="o">*</span><span class="p">[]</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">r1</span> <span class="kt">error</span>
	<span class="k">if</span> <span class="nx">rf</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ret</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="mi">1</span><span class="p">).(</span><span class="kd">func</span><span class="p">()</span> <span class="kt">error</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">r1</span> <span class="p">=</span> <span class="nf">rf</span><span class="p">()</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">r1</span> <span class="p">=</span> <span class="nx">ret</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">r0</span><span class="p">,</span> <span class="nx">r1</span>
<span class="p">}</span>

<span class="c1">// GetUser provides a mock function with given fields: id
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">_m</span> <span class="o">*</span><span class="nx">UserService</span><span class="p">)</span> <span class="nf">GetUser</span><span class="p">(</span><span class="nx">id</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">ret</span> <span class="o">:=</span> <span class="nx">_m</span><span class="p">.</span><span class="nf">Called</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>

	<span class="kd">var</span> <span class="nx">r0</span> <span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span>
	<span class="k">if</span> <span class="nx">rf</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ret</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="mi">0</span><span class="p">).(</span><span class="kd">func</span><span class="p">(</span><span class="kt">uint64</span><span class="p">)</span> <span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">r0</span> <span class="p">=</span> <span class="nf">rf</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">ret</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">r0</span> <span class="p">=</span> <span class="nx">ret</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="mi">0</span><span class="p">).(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">r1</span> <span class="kt">error</span>
	<span class="k">if</span> <span class="nx">rf</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ret</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="mi">1</span><span class="p">).(</span><span class="kd">func</span><span class="p">(</span><span class="kt">uint64</span><span class="p">)</span> <span class="kt">error</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">r1</span> <span class="p">=</span> <span class="nf">rf</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">r1</span> <span class="p">=</span> <span class="nx">ret</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">r0</span><span class="p">,</span> <span class="nx">r1</span>
<span class="p">}</span></code></pre></div>
<h3 id="writing-the-unit-test-cases">Writing the unit test cases</h3>

<p>接着我们就要来写相关的测试用例了，下面我们测试了POST, GET, DELETE几个方法，而其中并没有去连接数据库，但是能测试到<code>userController</code>的业务逻辑。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">controller</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;hidevops.io/hiboot-data/examples/gorm/entity&#34;</span>
	<span class="s">&#34;hidevops.io/hiboot/pkg/app/web&#34;</span>
	<span class="s">&#34;hidevops.io/hiboot/pkg/log&#34;</span>
	<span class="s">&#34;hidevops.io/hiboot/pkg/utils/idgen&#34;</span>
	<span class="s">&#34;github.com/stretchr/testify/assert&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
	<span class="s">&#34;testing&#34;</span>
	<span class="s">&#34;hidevops.io/hiboot-data/examples/gorm/service/mocks&#34;</span>
	<span class="s">&#34;errors&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">SetLevel</span><span class="p">(</span><span class="nx">log</span><span class="p">.</span><span class="nx">DebugLevel</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestCrdRequest</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>

	<span class="nx">mockUserService</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">mocks</span><span class="p">.</span><span class="nx">UserService</span><span class="p">)</span>
	<span class="nx">userController</span> <span class="o">:=</span> <span class="nf">newUserController</span><span class="p">(</span><span class="nx">mockUserService</span><span class="p">)</span>
	<span class="nx">testApp</span> <span class="o">:=</span> <span class="nx">web</span><span class="p">.</span><span class="nf">RunTestApplication</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">userController</span><span class="p">)</span>

	<span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">idgen</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span>
	<span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>

	<span class="nx">testUser</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">{</span>
		<span class="nx">Id</span><span class="p">:</span>       <span class="nx">id</span><span class="p">,</span>
		<span class="nx">Name</span><span class="p">:</span>     <span class="s">&#34;Bill Gates&#34;</span><span class="p">,</span>
		<span class="nx">Username</span><span class="p">:</span> <span class="s">&#34;billg&#34;</span><span class="p">,</span>
		<span class="nx">Password</span><span class="p">:</span> <span class="s">&#34;3948tdaD&#34;</span><span class="p">,</span>
		<span class="nx">Email</span><span class="p">:</span>    <span class="s">&#34;bill.gates@microsoft.com&#34;</span><span class="p">,</span>
		<span class="nx">Age</span><span class="p">:</span>      <span class="mi">60</span><span class="p">,</span>
		<span class="nx">Gender</span><span class="p">:</span>   <span class="mi">1</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="c1">// first, call mocks.UserService.AddUser
</span><span class="c1"></span>	<span class="nx">mockUserService</span><span class="p">.</span><span class="nf">On</span><span class="p">(</span><span class="s">&#34;AddUser&#34;</span><span class="p">,</span> <span class="nx">testUser</span><span class="p">).</span><span class="nf">Return</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
	<span class="c1">// then run the test that will call UserService.AddUser
</span><span class="c1"></span>	<span class="nx">t</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s">&#34;should add user with POST request&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// First, let&#39;s Post User
</span><span class="c1"></span>		<span class="nx">testApp</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">&#34;/user&#34;</span><span class="p">).</span>
			<span class="nf">WithJSON</span><span class="p">(</span><span class="nx">testUser</span><span class="p">).</span>
			<span class="nf">Expect</span><span class="p">().</span><span class="nf">Status</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">)</span>
	<span class="p">})</span>

	<span class="nx">mockUserService</span><span class="p">.</span><span class="nf">On</span><span class="p">(</span><span class="s">&#34;GetUser&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">).</span><span class="nf">Return</span><span class="p">(</span><span class="nx">testUser</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
	<span class="nx">t</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s">&#34;should get user with GET request&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// Then Get User
</span><span class="c1"></span>		<span class="c1">// e.g. GET /user/id/123456
</span><span class="c1"></span>		<span class="nx">testApp</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/user/id/{id}&#34;</span><span class="p">).</span>
			<span class="nf">WithPath</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">).</span>
			<span class="nf">Expect</span><span class="p">().</span><span class="nf">Status</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">)</span>
	<span class="p">})</span>

	<span class="nx">mockUserService</span><span class="p">.</span><span class="nf">On</span><span class="p">(</span><span class="s">&#34;GetAll&#34;</span><span class="p">).</span><span class="nf">Return</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[]</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">{</span><span class="o">*</span><span class="nx">testUser</span><span class="p">},</span> <span class="kc">nil</span><span class="p">)</span>
	<span class="nx">t</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s">&#34;should get user with GET request&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// Then Get User
</span><span class="c1"></span>		<span class="c1">// e.g. GET /user/id/123456
</span><span class="c1"></span>		<span class="nx">testApp</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/user/all&#34;</span><span class="p">).</span>
			<span class="nf">Expect</span><span class="p">().</span><span class="nf">Status</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">)</span>
	<span class="p">})</span>

	<span class="c1">// assert that the expectations were met
</span><span class="c1"></span>	<span class="nx">mockUserService</span><span class="p">.</span><span class="nf">AssertExpectations</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>

	<span class="nx">unknownId</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">idgen</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span>
	<span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="nx">mockUserService</span><span class="p">.</span><span class="nf">On</span><span class="p">(</span><span class="s">&#34;GetUser&#34;</span><span class="p">,</span> <span class="nx">unknownId</span><span class="p">).</span><span class="nf">Return</span><span class="p">((</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;not found&#34;</span><span class="p">))</span>

	<span class="nx">t</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s">&#34;should return 404 if trying to find a record that does not exist&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// Then Get User
</span><span class="c1"></span>		<span class="nx">testApp</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/user/id/{id}&#34;</span><span class="p">).</span>
			<span class="nf">WithPath</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="nx">unknownId</span><span class="p">).</span>
			<span class="nf">Expect</span><span class="p">().</span><span class="nf">Status</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusNotFound</span><span class="p">)</span>
	<span class="p">})</span>

	<span class="c1">// assert that the expectations were met
</span><span class="c1"></span>	<span class="nx">mockUserService</span><span class="p">.</span><span class="nf">AssertExpectations</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>

	<span class="nx">mockUserService</span><span class="p">.</span><span class="nf">On</span><span class="p">(</span><span class="s">&#34;DeleteUser&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">).</span><span class="nf">Return</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
	<span class="nx">t</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s">&#34;should delete the record with DELETE request&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// Finally Delete User
</span><span class="c1"></span>		<span class="nx">testApp</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="s">&#34;/user/id/{id}&#34;</span><span class="p">).</span>
			<span class="nf">WithPath</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">).</span>
			<span class="nf">Expect</span><span class="p">().</span><span class="nf">Status</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">)</span>
	<span class="p">})</span>
<span class="p">}</span></code></pre></div>
<p>最后，我们来运行测试用例，</p>

<p><img src="https://hiboot.hidevops.io/images/web-app/unit-test.png" alt="unit-test" /></p>

                <div class="order-0 w-20 dn db-l">
                    
<nav role="navigation">
  <ul class="list pa0 nl2">
    
      
      <li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8">
        <a href="javascript:void(0)" class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2  primary-color" data-target=".Hiboot云原生应用框架">Hiboot云原生应用框架</a>
        <ul class="Hiboot云原生应用框架 desktopmenu animated fadeIn list pl0 bg-light-gray db">
          <li class="f6 fw4">
            <a href="https://hiboot.hidevops.io/cn/getting-started/" class="db link hover-bg-gray hover-white pl3 pr2 pv2 black ">
              入门
            </a>
          </li>
          <li class="f6 fw4">
            <a href="https://hiboot.hidevops.io/cn/cli-app/" class="db link hover-bg-gray hover-white pl3 pr2 pv2 black ">
              命令行应用
            </a>
          </li>
          <li class="f6 fw4">
            <a href="https://hiboot.hidevops.io/cn/web-app/" class="db link hover-bg-gray hover-white pl3 pr2 pv2 primary-color ">
              网络应用
            </a>
          </li>
          <li class="f6 fw4">
            <a href="https://hiboot.hidevops.io/cn/auto-configure/" class="db link hover-bg-gray hover-white pl3 pr2 pv2 black ">
              自动配置
            </a>
          </li>
        </ul>
      </li>
  </ul>
</nav>

                </div>
                <aside class="copyright" role="note">
                     &copy; 2019 Released under the Apache 2.0 license &ndash;  - By John Deng.
                </aside>
            </div>

            <footer class="footer">
                

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="https://hiboot.hidevops.io/cn/cli-app/" title="命令行应用">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              命令行应用
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="https://hiboot.hidevops.io/cn/getting-started/" title="入门">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              入门
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





            </footer>
        </div>
    </article>
    <div class="sticky">
	
	
	
	
		
		
		
	
		
		<div class="col-md-2 pl-0">
			
			<div id="page-scrollspy" class="toc-nav">
				
				<ul class="nav nav-pills ml-0">
					
					<li class="nav-item pb-3 text-center">
						<span class="font-weight-bold mb-2">- What's on this Page - </span>
					</li>
					
						
						
							
								
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#%e4%b8%bb%e8%a6%81%e5%8a%9f%e8%83%bd">
												 主要功能
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#mvc%e6%9e%b6%e6%9e%84%e4%bb%8b%e7%bb%8d">
												 MVC架构介绍
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#mvc%e9%a1%b9%e7%9b%ae%e7%bb%93%e6%9e%84%e8%af%a6%e8%a7%a3">
												 MVC项目结构详解
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#%e5%a4%96%e9%83%a8%e9%85%8d%e7%bd%ae">
												 外部配置
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#%e9%80%9a%e7%94%a8application%e5%b1%9e%e6%80%a7%e6%96%87%e4%bb%b6">
												 通用Application属性文件
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#config-application-yml">
												 config/application.yml
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#application-yml%e5%ad%97%e6%ae%b5%e8%af%b4%e6%98%8e">
												 application.yml字段说明
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#config-application-local-yml">
												 config/application-local.yml
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#application-local-yml-%e5%ad%97%e6%ae%b5%e8%af%b4%e6%98%8e">
												 application-local.yml 字段说明
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#config-application-gorm-yml">
												 config/application-gorm.yml
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#application-gorm-yml%e5%ad%97%e6%ae%b5%e8%af%b4%e6%98%8e">
												 application-gorm.yml字段说明
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#main-go">
												 main.go
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#mian-test-go">
												 mian_test.go
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#%e6%8e%a7%e5%88%b6%e5%99%a8-controller-user-go">
												 控制器 - controller/user.go
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#entity-user-go">
												 entity/user.go
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#model-service-user-go">
												 Model - service/user.go
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#%e8%bf%90%e8%a1%8c%e7%bd%91%e7%bb%9c%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f">
												 运行网络应用程序
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#%e8%af%b7%e6%b1%82%e6%8e%a5%e5%8f%a3">
												 请求接口
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95">
												 单元测试
											</a>
										</li>
						 
								
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#mian-test-go-1">
												 mian_test.go
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#%e6%a8%a1%e6%8b%9f%e6%b5%8b%e8%af%95-controller-user-test-go">
												 模拟测试 - controller/user_test.go
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
						
						
							
								
								
									<ul class="nav">
								
									<ul class="nav">
								
								
										<li class="nav-item">
						 					<a class="nav-link" href="#writing-the-unit-test-cases">
												 Writing the unit test cases
											</a>
										</li>
						 
								
								
									</ul>
								
									</ul>
								
							
						
				 
				</ul>
			</div>
			
		</div>
		
	</div>
    <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
            <div class="wrapper">
                <div class="meta"></div>
                <div class="list"></div>
            </div>
        </div>
    </div>
</main>

    <script>
    
      var base_url = 'https:\/\/hiboot.hidevops.io\/';
      var repo_id  = '\/';
    
    </script>

    <script src="https://hiboot.hidevops.io/javascripts/application.js"></script>
    <script src="https://hiboot.hidevops.io/javascripts/menutoggle.js"></script>
    <script src="https://hiboot.hidevops.io/javascripts/bootstrap.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = " ";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>
